---
import { createSupabaseClient } from "../../../lib/supabase";
import Navbar from "../../../components/Navbar.astro";
import '.././../../styles/global.css';

const { id } = Astro.params;
const supabase = createSupabaseClient(Astro);

const { data: { user } } = await supabase.auth.getUser();
if (!user) return Astro.redirect("/login");

const { data: post, error } = await supabase
  .from("posts")
  .select("*")
  .eq("id", id)
  .single();

if (error || !post || post.author_id !== user.id) {
  return Astro.redirect("/dashboard");
}
---

<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Edit Echo | {post.title}</title>
</head>
<body>
    <Navbar />

    <main class="container" style="max-width: 800px; padding: 60px 20px;">
        <header style="margin-bottom: 40px;">
            <div style="color: var(--primary-green); font-size: 0.8rem; font-weight: 700; text-transform: uppercase; letter-spacing: 2px; margin-bottom: 10px;">
                Editor Mode
            </div>
            <h1 style="font-size: 3rem; font-weight: 800; line-height: 1.1; margin: 0;">Edit <span style="color: var(--primary-green);">Echo.</span></h1>
        </header>

        <div class="card" style="padding: 40px; border: 1px solid var(--border-color); background: rgba(255,255,255,0.02);">
            <form method="POST" action="/api/posts/update">
                <input type="hidden" name="id" value={post.id} />
                
                <div style="margin-bottom: 30px;">
                    <label style="display: block; color: var(--text-muted); font-size: 0.9rem; margin-bottom: 10px; font-weight: 600;">
                        Headline
                    </label>
                    <input 
                        type="text" 
                        name="title" 
                        value={post.title} 
                        required 
                        style="width: 100%; background: var(--bg-dark); border: 1px solid var(--border-color); border-radius: 8px; padding: 15px; color: white; font-size: 1.2rem; font-weight: 600; outline: none;" 
                        onfocus="this.style.borderColor='var(--primary-green)'"
                        onblur="this.style.borderColor='var(--border-color)'"
                    />
                </div>

                <div style="margin-bottom: 30px;">
                    <label style="display: block; color: var(--text-muted); font-size: 0.9rem; margin-bottom: 10px; font-weight: 600;">
                        Story Content
                    </label>
                    <textarea 
                        name="content" 
                        required 
                        rows="15" 
                        style="width: 100%; background: var(--bg-dark); border: 1px solid var(--border-color); border-radius: 8px; padding: 20px; color: #e0e0e0; font-size: 1.1rem; line-height: 1.6; resize: vertical; outline: none;"
                        onfocus="this.style.borderColor='var(--primary-green)'"
                        onblur="this.style.borderColor='var(--border-color)'"
                    >{post.content}</textarea>
                </div>

                <div style="display: flex; align-items: center; gap: 20px;">
                    <button type="submit" class="btn btn-primary" style="flex: 2; padding: 15px; font-weight: 700; font-size: 1rem;">
                        Save Changes
                    </button>
                    <a href="/dashboard" style="flex: 1; text-align: center; text-decoration: none; color: var(--text-muted); font-size: 0.9rem; font-weight: 600; transition: color 0.2s;" onmouseover="this.style.color='white'" onmouseout="this.style.color='var(--text-muted)'">
                        Discard Changes
                    </a>
                </div>
            </form>
        </div>
    </main>
</body>
</html>