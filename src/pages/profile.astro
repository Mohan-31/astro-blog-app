---
import { createSupabaseClient } from "../lib/supabase";
import Navbar from "../components/Navbar.astro";
import '../styles/global.css';

const supabase = createSupabaseClient(Astro);
const { data: { user } } = await supabase.auth.getUser();

if (!user) return Astro.redirect("/login");

const { data: profile } = await supabase
  .from("profiles")
  .select("*")
  .eq("id", user.id)
  .single();

const url = new URL(Astro.request.url);
const success = url.searchParams.get("success");
---

<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Account Settings | EchoLog</title>
</head>
<body style="display: flex; flex-direction: column; min-height: 100vh;">
    <Navbar />

    <main class="container" style="flex: 1; display: flex; align-items: center; justify-content: center; padding: 40px 0;">
        <div class="card" style="width: 100%; max-width: 550px;">
            <header style="text-align: center; margin-bottom: 2.5rem;">
                <h1 style="font-size: 2rem; font-weight: 800; margin-bottom: 10px;">Account Settings</h1>
                <p style="color: var(--text-muted); font-size: 0.95rem;">Manage your public identity on EchoLog</p>
            </header>

            <div style="background: var(--bg-dark); border-radius: 8px; padding: 15px; margin-bottom: 2rem; border: 1px solid var(--border-color);">
                <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                    <span style="color: var(--text-muted); font-size: 0.85rem; font-weight: 600; text-transform: uppercase;">Email</span>
                    <span style="color: var(--text-main); font-size: 0.9rem;">{user.email}</span>
                </div>
                <div style="display: flex; justify-content: space-between;">
                    <span style="color: var(--text-muted); font-size: 0.85rem; font-weight: 600; text-transform: uppercase;">User ID</span>
                    <span style="color: var(--primary-green); font-family: monospace; font-size: 0.8rem;">{user.id.slice(0,18)}...</span>
                </div>
            </div>

            {success && (
                <div style="background: rgba(0, 223, 129, 0.1); color: var(--primary-green); border: 1px solid var(--primary-green); padding: 12px; border-radius: 8px; margin-bottom: 2rem; text-align: center; font-weight: 600;">
                    ✓ Profile updated successfully!
                </div>
            )}

            <form method="POST" action="/api/auth/update-profile">
                <div style="margin-bottom: 2rem;">
                    <label for="username" style="display: block; font-weight: 600; margin-bottom: 8px; color: var(--text-main);">
                        Display Name (Username)
                    </label>
                    <input 
                        type="text" 
                        id="username"
                        name="username" 
                        value={profile?.username || ""} 
                        placeholder="e.g. CodeMaster99"
                        required
                    />
                    <small style="color: var(--text-muted); display: block; margin-top: 5px;">This is how you will appear to other users in comments.</small>
                </div>
                
                <button type="submit" class="btn btn-primary" style="width: 100%; padding: 14px; font-size: 1rem;">
                    Save Profile Changes
                </button>
            </form>

            <div style="margin-top: 2rem; text-align: center; border-top: 1px solid var(--border-color); padding-top: 20px;">
                <a href="/dashboard" style="color: var(--text-muted); text-decoration: none; font-size: 0.9rem; transition: color 0.3s;" onmouseover="this.style.color='var(--primary-green)'" onmouseout="this.style.color='var(--text-muted)'">
                    ← Back to Dashboard
                </a>
            </div>
        </div>
    </main>
</body>
</html>