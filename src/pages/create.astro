---
import { createSupabaseClient } from "../lib/supabase";
import Navbar from "../components/Navbar.astro";
import '../styles/global.css';

let error = "";
const supabase = createSupabaseClient(Astro);

const { data: { user } } = await supabase.auth.getUser();
if (!user) {
  return Astro.redirect("/login?error=session_expired");
}

if (Astro.request.method === "POST") {
  try {
    const formData = await Astro.request.formData();
    const title = formData.get("title")?.toString();
    const content = formData.get("content")?.toString();

    const { error: insertError } = await supabase
      .from("posts")
      .insert({
        title,
        content,
        author_id: user.id, 
      });

    if (insertError) {
      error = insertError.message;
    } else {
      return Astro.redirect("/dashboard");
    }
  } catch (e) {
    error = "Server error parsing form data.";
  }
}
---

<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Create New Echo | EchoLog</title>
</head>
<body style="display: flex; flex-direction: column; min-height: 100vh;">
    <Navbar />

    <main class="container" style="flex: 1; display: flex; align-items: center; justify-content: center; padding: 40px 0;">
        <div class="card" style="width: 100%; max-width: 700px; padding: 2.5rem;">
            
            <header style="margin-bottom: 2rem;">
                <h1 style="font-size: 2.2rem; font-weight: 800; margin-bottom: 10px;">
                    Create New <span style="color: var(--primary-green);">Echo.</span>
                </h1>
                <p style="color: var(--text-muted);">Share your thoughts with the world.</p>
            </header>

            {error && (
                <div style="background: rgba(250, 82, 82, 0.1); color: #fa5252; border: 1px solid rgba(250, 82, 82, 0.2); padding: 12px; border-radius: 8px; margin-bottom: 1.5rem; font-size: 0.9rem;">
                   ⚠️ {error}
                </div>
            )}

            <form method="POST" style="display: flex; flex-direction: column; gap: 20px;">
                <div>
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                        <label for="title" style="font-weight: 600; color: var(--text-main);">Post Title</label>
                        <span id="title-counter" style="font-size: 0.75rem; color: var(--text-muted);">0 / 100</span>
                    </div>
                    <input 
                        type="text" 
                        id="title"
                        name="title" 
                        maxlength="100"
                        placeholder="Give your story a bold name..." 
                        required 
                        style="width: 100%; padding: 14px; font-size: 1.1rem; border-radius: 8px; border: 1px solid var(--border-color); background: var(--bg-dark); color: white;"
                    />
                </div>

                <div>
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                        <label for="content" style="font-weight: 600; color: var(--text-main);">Content</label>
                        <span id="word-counter" style="font-size: 0.75rem; color: var(--primary-green); font-weight: 600;">0 words</span>
                    </div>
                    <textarea 
                        id="content"
                        name="content" 
                        placeholder="What's on your mind? Use your voice..." 
                        required 
                        rows="12"
                        style="width: 100%; padding: 14px; font-size: 1rem; border-radius: 8px; border: 1px solid var(--border-color); background: var(--bg-dark); color: white; resize: vertical; line-height: 1.6;"
                    ></textarea>
                </div>

                <div style="display: flex; align-items: center; justify-content: space-between; gap: 20px; margin-top: 10px;">
                    <a href="/dashboard" style="color: var(--text-muted); text-decoration: none; font-size: 0.9rem;">Cancel</a>
                    <button type="submit" class="btn btn-primary" style="padding: 12px 40px; font-size: 1rem; font-weight: 700;">
                        Publish Echo
                    </button>
                </div>
            </form>
        </div>
    </main>

    <script>
        const titleInput = document.getElementById('title');
        const titleCounter = document.getElementById('title-counter');
        const contentInput = document.getElementById('content');
        const wordCounter = document.getElementById('word-counter');

        titleInput?.addEventListener('input', (e) => {
            const target = e.target as HTMLInputElement;
            titleCounter!.textContent = `${target.value.length} / 100`;
            if (target.value.length >= 90) {
                titleCounter!.style.color = '#fa5252';
            } else {
                titleCounter!.style.color = 'var(--text-muted)';
            }
        });

        contentInput?.addEventListener('input', (e) => {
            const target = e.target as HTMLTextAreaElement;
            const words = target.value.trim().split(/\s+/).filter(word => word.length > 0);
            wordCounter!.textContent = `${words.length} ${words.length === 1 ? 'word' : 'words'}`;
        });
    </script>
</body>
</html>